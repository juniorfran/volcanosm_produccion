{% extends "base.html" %}
{% load static %}

{% block content %}

<link rel="icon" href="{% static 'img/favicon.png' %}" />

<style>
/* ======= HERO (sin imagen) ======= */
.hero-solid{
  position:relative;border-radius:.9rem;padding:2.5rem 1.25rem;color:#fff;overflow:hidden;
  background: radial-gradient(1400px 700px at 110% -40%, rgba(40,167,69,.20), transparent 60%),
              radial-gradient(1200px 600px at -10% 120%, rgba(0,123,255,.18), transparent 60%),
              linear-gradient(135deg,#0f172a,#111827 55%,#0b1324);
  box-shadow:0 .75rem 2rem rgba(0,0,0,.25); text-align:center;
}
.hero-solid:before,.hero-solid:after{content:"";position:absolute;width:380px;height:380px;border-radius:50%;
  filter:blur(60px);opacity:.25;pointer-events:none}
.hero-solid:before{background:#28a745; top:-160px; left:-120px}
.hero-solid:after {background:#007bff; bottom:-200px; right:-140px}
.hero-kicker{letter-spacing:.25rem;text-transform:uppercase;font-weight:700;font-size:.8rem;
  padding:.35rem .75rem;border:1px solid rgba(255,255,255,.25);border-radius:50rem;background:rgba(255,255,255,.06)}
.hero-title{margin:.9rem 0 .5rem;line-height:1.2;font-weight:800}
.hero-sub{color:rgba(255,255,255,.85);max-width:820px;margin:0 auto 1.25rem}
.hero-cta .btn{margin:.25rem .35rem}

/* ======= LAYOUT ======= */
.sidebar-sticky{position:sticky;top:1rem}
.filters-card{border:0;box-shadow:0 .5rem 1rem rgba(0,0,0,.08);border-radius:.75rem}
.filters-card .card-header{background:#fff;border-bottom:1px solid #f1f3f5}
.filters-card .pill{border-radius:50px;padding:.25rem .75rem;border:1px solid #dee2e6;cursor:pointer;display:inline-flex;align-items:center}
.filters-card .pill.active{background:#e9f7ef;border-color:#28a745;color:#155724}
.results-toolbar{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
.results-toolbar .btn-group .btn{padding:.375rem .5rem}
.results-toolbar .form-control{height:calc(1.5em + .5rem + 2px);padding:.25rem .5rem;font-size:.9rem}

/* ======= MEDIA / IMG ======= */
.media-wrap{position:relative}
.ratio-box{position:relative;width:100%;padding-top:66.66%;overflow:hidden;border-radius:.5rem}
.ratio-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;transition:transform .35s ease}
.media-wrap:hover .ratio-img{transform:scale(1.04)}
.img-gradient::after{content:"";position:absolute;left:0;right:0;bottom:0;height:55%;
  background:linear-gradient(180deg,rgba(0,0,0,0) 0%,rgba(0,0,0,.65) 100%);border-radius:.5rem}

/* ======= CARD ======= */
.tour-card{border:0;border-radius:.75rem;overflow:hidden;box-shadow:0 .5rem 1rem rgba(0,0,0,.08);transition:transform .25s,box-shadow .25s;display:flex;flex-direction:column;height:100%}
.tour-card:hover{transform:translateY(-2px);box-shadow:0 .75rem 1.5rem rgba(0,0,0,.12)}
.card-body{display:flex;flex-direction:column}

/* --- NUEVO: acciones al pie, más bajas y con fondo --- */
.card-actions{
  margin-top:auto;
  padding:1.15rem .9rem 1rem;                 /* + espacio arriba para “bajar” los botones */
  border-top:1px solid #eef1f3;
  background:linear-gradient(180deg,#fff, #fafbfc);
}
.actions-wrap{display:flex;align-items:center;justify-content:space-between;gap:.75rem}
.price-stack .label{font-size:.75rem;color:#6c757d;display:block;line-height:1}
.price-stack .price{font-weight:700;font-size:1.05rem;margin:0;line-height:1.15}
.actions-buttons{display:flex;gap:.5rem}

/* --- NUEVO: estilos de botones --- */
.btn-pill{border-radius:50rem}
.btn-ghost{background:#fff;border:1px solid #dbe2e8}
.btn-ghost:hover{background:#f8fafc}
.btn-cta{
  background:linear-gradient(135deg,#28a745,#1e8e3e);
  border:0;color:#fff;
  box-shadow:0 .25rem .75rem rgba(40,167,69,.25)
}
.btn-cta:hover{filter:brightness(.98)}
.btn-icon{display:inline-flex;align-items:center;gap:.35rem}
.btn-ghost-dark{border-color:#CED4DA;color:#212529}

.ribbon{position:absolute;top:.75rem;left:-.5rem;background:#dc3545;color:#fff;padding:.25rem .75rem;transform:rotate(-8deg);font-weight:600;border-radius:.25rem;box-shadow:0 .25rem .5rem rgba(0,0,0,.15)}
.ribbon-new{background:#17a2b8}
.wishlist{position:absolute;top:.65rem;right:.65rem;z-index:2}
.wishlist .btn{background:rgba(0,0,0,.5);color:#fff;border:0}
.wishlist .btn.active{background:#ff2d55}
.feature-chips{display:flex;gap:.35rem;flex-wrap:wrap}
.feature-chip{font-size:.8rem;border:1px solid #e9ecef;background:#f8f9fa;border-radius:50rem;padding:.15rem .5rem}

/* ======= LIST VIEW ======= */
.list-view .col-card{flex:0 0 100%;max-width:100%}
.list-view .tour-card{flex-direction:row;min-height:220px}
.list-view .media-wrap{flex:0 0 38%;max-width:38%}
.list-view .ratio-box{padding-top:0;height:100%;min-height:220px;border-radius:0} /* altura mínima para que la imagen no se “aplane” */
.list-view .ratio-img{position:absolute;width:100%;height:100%;object-fit:cover}
.list-view .card-body{padding:1rem 1.25rem}
.list-view .card-actions{padding:1rem 1.25rem}  /* mismo padding lateral */

/* ======= SKELETON ======= */
.skeleton{background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:skeleton 1.2s infinite}
@keyframes skeleton{0%{background-position:200% 0}100%{background-position:-200% 0}}

.pagination .page-link{border:0;border-radius:.5rem;margin:0 .125rem;box-shadow:0 .25rem .5rem rgba(0,0,0,.06)}

/* ======= Responsive botones ======= */
@media (max-width: 575.98px){
  .actions-wrap{flex-direction:column;align-items:flex-start}
  .actions-buttons{width:100%}
  .actions-buttons .btn{flex:1 1 auto}
}

/* QuickView descripción con altura controlada */
.qv-desc{
  max-height: 140px;
  overflow: auto;
  border-top: 1px solid #eef1f3;
  border-bottom: 1px solid #eef1f3;
  padding: .75rem 0;
  line-height: 1.4;
}
</style>

<div class="container py-4">
  <!-- HERO -->
  <section class="hero-solid mb-4">
    <span class="hero-kicker">Aventuras únicas</span>
    <h1 class="hero-title">Vive la magia del volcán</h1>
    <p class="hero-sub">Paisajes impresionantes, guías expertos y experiencias que recordarás toda la vida.</p>
    <div class="hero-cta">
      <a href="#grid" class="btn btn-success btn-lg">Explorar tours</a>
      <a href="{% url 'contacto' %}" class="btn btn-outline-light btn-lg">Asesor gratuito</a>
    </div>
  </section>

  <div class="row">
    <!-- ===== Sidebar filtros ===== -->
    <aside class="col-lg-3 mb-4">
      <div class="filters-card card sidebar-sticky">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong class="mb-0">Filtros</strong>
          <a href="?">Limpiar</a>
        </div>
        <div class="card-body">
          <form method="get" id="filtersForm">
            <div class="form-group">
              <label class="small text-muted">Buscar</label>
              <input id="q" name="q" value="{{ request.GET.q }}" type="text" class="form-control" placeholder="Nombre del tour, destino">
            </div>

            <div class="form-group">
              <label class="small text-muted">Tipo</label>
              <select id="tipo" name="tipo" class="form-control">
                <option value="">Todos</option>
                {% for t in tipos %}
                  <option value="{{ t.0 }}" {% if request.GET.tipo == t.0 %}selected{% endif %}>{{ t.1 }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label class="small text-muted">Duración</label>
              <select id="duracion" name="duracion" class="form-control">
                <option value="">Cualquiera</option>
                <option value="0-4"  {% if request.GET.duracion == '0-4'  %}selected{% endif %}>Hasta 4 h</option>
                <option value="4-8"  {% if request.GET.duracion == '4-8'  %}selected{% endif %}>4–8 h</option>
                <option value="8-99" {% if request.GET.duracion == '8-99' %}selected{% endif %}>8+ h</option>
              </select>
            </div>

            {% with pm=precio_max|default:300 pv=precio_val|default:precio_max|default:300 %}
            <div class="form-group">
              <label class="small text-muted d-flex justify-content-between">
                <span>Precio máx (USD)</span>
                <span id="precioOut">${{ pv }}</span>
              </label>
              <input id="precio" name="precio" type="range" min="0" max="{{ pm }}" step="5" value="{{ pv }}" class="w-100">
              <div class="d-flex justify-content-between small text-muted"><span>$0</span><span>${{ pm }}</span></div>
            </div>
            {% endwith %}

            <div class="custom-control custom-checkbox mb-3">
              <input type="checkbox" class="custom-control-input" id="solo_finde" name="solo_finde" value="1" {% if request.GET.solo_finde %}checked{% endif %}>
              <label class="custom-control-label" for="solo_finde">Solo fines de semana</label>
            </div>

            <div class="mb-3">
              <div class="small text-muted mb-1">Búsquedas rápidas</div>
              <span class="pill quick mr-2 mb-2" data-q="familiar">Familiar</span>
              <span class="pill quick mr-2 mb-2" data-q="amanecer">Amanecer</span>
              <span class="pill quick mr-2 mb-2" data-q="caminata">Caminata</span>
              <span class="pill quick mr-2 mb-2" data-q="fotografía">Fotografía</span>
            </div>

            <div class="form-group">
              <label class="small text-muted">Ordenar por</label>
              <select id="orden" name="orden" class="form-control">
                <option value="">Relevancia</option>
                <option value="precio"    {% if request.GET.orden == 'precio' %}selected{% endif %}>Precio (menor a mayor)</option>
                <option value="-precio"   {% if request.GET.orden == '-precio' %}selected{% endif %}>Precio (mayor a menor)</option>
                <option value="duracion"  {% if request.GET.orden == 'duracion' %}selected{% endif %}>Duración (corta a larga)</option>
                <option value="-duracion" {% if request.GET.orden == '-duracion' %}selected{% endif %}>Duración (larga a corta)</option>
              </select>
            </div>

            <button class="btn btn-success btn-block">
              <i class="fa fa-filter mr-1"></i>Aplicar filtros
            </button>
          </form>
        </div>
      </div>
    </aside>

    <!-- ===== Contenido ===== -->
    <section class="col-lg-9">
      <div class="d-flex justify-content-between align-items-center mb-3 results-toolbar">
        <div class="text-muted">Mostrando <strong>{{ tours|length }}</strong> tours</div>
        <div class="ml-auto btn-group" role="group" aria-label="Vista">
          <button type="button" class="btn btn-outline-secondary btn-sm toggle-view active" data-view="grid" title="Vista de cuadrícula"><i class="fa fa-th-large"></i></button>
          <button type="button" class="btn btn-outline-secondary btn-sm toggle-view" data-view="list" title="Vista de lista"><i class="fa fa-list"></i></button>
        </div>
      </div>

      <div id="grid" class="grid-wrapper">
        {% if tours %}
          <div class="row" id="gridRow">
            {% for tour in tours %}
              <div class="col-xl-4 col-md-6 mb-4 d-flex col-card">
                <div class="card tour-card w-100">
                  <!-- Media -->
                  <div class="media-wrap img-gradient">
                    <div class="ratio-box skeleton">
                      <img class="ratio-img lazy" data-src="{{ tour.url_azure }}" alt="{{ tour.titulo }}">
                    </div>
                    {% if not tour.disponible %}<div class="ribbon">No disponible</div>{% endif %}
                    {% if tour.es_nuevo %}<div class="ribbon ribbon-new">Nuevo</div>{% endif %}
                    <div class="wishlist">
                      <button type="button" class="btn btn-sm rounded-circle like-btn" data-id="{{ tour.id }}" title="Guardar">
                        <i class="fa fa-heart"></i>
                      </button>
                    </div>
                  </div>

                  <!-- Body -->
                  <div class="card-body">
                    <div class="d-flex align-items-start">
                      <h5 class="card-title mb-1 mr-2 text-truncate" title="{{ tour.titulo }}">{{ tour.titulo }}</h5>
                      {% if tour.solo_finde %}<span class="badge badge-warning">Sáb–Dom</span>{% endif %}
                    </div>

                    <p class="text-muted small mb-2">
                      <i class="far fa-clock"></i> {{ tour.duracion }} h
                      {% if tour.tipo_tour %} · <i class="far fa-compass"></i> {{ tour.tipo_tour }}{% endif %}
                    </p>

                    <div class="feature-chips mb-2">
                      <span class="feature-chip"><i class="fa fa-users mr-1"></i> Guía incluido</span>
                      <span class="feature-chip"><i class="fa fa-shield mr-1"></i> Pago seguro</span>
                      {% if tour.iva %}<span class="feature-chip"><i class="fa fa-receipt mr-1"></i> IVA incluido</span>{% endif %}
                    </div>

                    <div class="feature-chips mb-2">
                      <span class="feature-chip">Disfruta de una experiencia inolvidable en <strong>{{ tour.titulo }}</strong></span>
                      
                    </div>

                   <!-- Acciones / Precios al pie -->
                  <div class="card-actions">
                    <div class="actions-wrap">
                      <!-- Precios -->
                      <div class="d-flex align-items-end">
                        <div class="price-stack mr-3">
                          <small class="label">Adulto</small>
                          <div class="price">${{ tour.precio_adulto }}</div>
                        </div>
                        <div class="price-stack">
                          <small class="label">Niño</small>
                          <div class="price">${{ tour.precio_nino }}</div>
                        </div>
                      </div>
                      
                    </div>
                    <br>
                     <!-- Botones -->
                      <div class="actions-buttons" role="group" aria-label="Acciones">
                        <a href="{% url 'tour_detail' tour.id %}" class="btn btn-ghost btn-pill btn-sm btn-icon">
                          <i class="fa fa-info-circle"></i> 
                        </a>

                        {% if tour.disponible %}
                          <a href="{% url 'reservar_tour' tour_id=tour.id %}" class="btn btn-cta btn-pill btn-sm btn-icon">
                            <i class="fa fa-calendar-check-o"></i> Reservar
                          </a>
                        {% else %}
                          <a href="{% url 'contacto' %}" class="btn btn-ghost btn-pill btn-sm btn-icon">
                            <i class="fa fa-life-ring"></i> Ayuda
                          </a>
                        {% endif %}

                        <button type="button"
                          class="btn btn-ghost-dark btn-pill btn-sm btn-icon quickview"
                          data-id="{{ tour.id }}"
                          data-title="{{ tour.titulo }}"
                          data-img="{{ tour.url_azure }}"
                          data-precio="{{ tour.precio_adulto }}"
                          data-duracion="{{ tour.duracion }}"
                          data-url="{% url 'tour_detail' tour.id %}"
                          data-desc="{{ tour.descripcion|striptags|truncatechars:220|escape }}">
                          <i class="fa fa-eye"></i>
                        </button>
                      </div>
                  </div>

                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-5">
            <h5 class="mb-2">No encontramos tours con esos filtros</h5>
            <p class="text-muted">Prueba con otros criterios o <a href="{% url 'contacto' %}">contáctanos</a>.</p>
          </div>
        {% endif %}
      </div>

      {% if is_paginated %}
        <nav aria-label="Tours pages">
          <ul class="pagination justify-content-center mt-3">
            {% if page_obj.has_previous %}
              <li class="page-item"><a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&' }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Anterior">&laquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}
            {% for i in paginator.page_range %}
              {% if i == page_obj.number %}
                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
              {% elif i >= page_obj.number|add:'-2' and i <= page_obj.number|add:'2' %}
                <li class="page-item"><a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&' }}&{% endif %}page={{ i }}">{{ i }}</a></li>
              {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
              <li class="page-item"><a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode|cut:'page='|cut:'&' }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Siguiente">&raquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </section>
  </div>
</div>

<!-- QUICK VIEW MODAL -->
<div class="modal fade" id="quickView" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-body p-0">
        <div class="row no-gutters">
          <div class="col-md-6">
            <div class="ratio-box"><img id="qv-img" class="ratio-img" alt=""></div>
          </div>
          <div class="col-md-6 p-4">
            <h5 id="qv-title" class="mb-1"></h5>
            <p class="text-muted small mb-2">
              <i class="far fa-clock"></i> <span id="qv-dur"></span> h
            </p>

            <!-- Resumen / descripción -->
            <div id="qv-desc" class="qv-desc text-muted small mb-3"></div>

            <div class="d-flex align-items-center mb-3">
              <div class="h4 mb-0">$<span id="qv-precio"></span></div>
              <small class="text-muted ml-2">Adulto</small>
            </div>

            <div class="d-flex">
              <a id="qv-url" href="#" class="btn btn-primary mr-2">Ver detalles</a>
              <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cerrar</button>
            </div>
            <div class="mt-3 text-muted small">* Cancelación flexible · Pago seguro</div>
          </div>
        </div>
      </div>
      <button type="button" class="close position-absolute" data-dismiss="modal" aria-label="Close" style="right:.75rem;top:.25rem;">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Precio live output
(function(){
  var r=document.getElementById('precio'), o=document.getElementById('precioOut');
  if(r&&o){ r.addEventListener('input', function(){ o.textContent='$'+this.value; }); }
})();

// Pills rápidas -> setear búsqueda
(function(){
  var pills=document.querySelectorAll('.quick'), q=document.getElementById('q');
  pills.forEach(function(p){
    p.addEventListener('click', function(){
      pills.forEach(x=>x.classList.remove('active'));
      this.classList.add('active'); if(q){ q.value=this.getAttribute('data-q'); }
    });
  });
})();

// Toggle Grid/List
(function(){
  var toggles=document.querySelectorAll('.toggle-view');
  var grid=document.getElementById('gridRow');
  toggles.forEach(function(b){
    b.addEventListener('click', function(){
      toggles.forEach(x=>x.classList.remove('active'));
      this.classList.add('active');
      var view=this.getAttribute('data-view');
      if(view==='list'){ grid.classList.add('list-view'); document.body.classList.add('list-view'); }
      else{ grid.classList.remove('list-view'); document.body.classList.remove('list-view'); }
    });
  });
})();

// Lazy load + skeleton
(function(){
  var imgs=document.querySelectorAll('img.lazy');
  if('IntersectionObserver' in window){
    var io=new IntersectionObserver(function(entries){
      entries.forEach(function(e){
        if(e.isIntersecting){
          var img=e.target; img.src=img.getAttribute('data-src');
          img.onload=function(){ img.parentElement.classList.remove('skeleton'); };
          io.unobserve(img);
        }
      });
    },{rootMargin:"200px"});
    imgs.forEach(i=>{ i.parentElement.classList.add('skeleton'); io.observe(i); });
  }else{ imgs.forEach(i=>{ i.src=i.getAttribute('data-src'); }); }
})();

// Wishlist (localStorage)
(function(){
  var key='wishlistTours', liked=JSON.parse(localStorage.getItem(key)||'[]');
  function sync(){ document.querySelectorAll('.like-btn').forEach(function(b){
    var id=String(b.getAttribute('data-id'));
    if(liked.indexOf(id)>=0) b.classList.add('active'); else b.classList.remove('active');
  });}
  sync();
  document.addEventListener('click', function(e){
    var btn=e.target.closest('.like-btn'); if(!btn) return;
    var id=String(btn.getAttribute('data-id')), i=liked.indexOf(id);
    if(i>=0) liked.splice(i,1); else liked.push(id);
    localStorage.setItem(key, JSON.stringify(liked)); sync();
  });
})();

// Quick View
(function(){
  document.addEventListener('click', function(e){
    var btn = e.target.closest('.quickview'); if(!btn) return;
    document.getElementById('qv-title').textContent = btn.getAttribute('data-title') || '';
    document.getElementById('qv-precio').textContent = btn.getAttribute('data-precio') || '';
    document.getElementById('qv-dur').textContent = btn.getAttribute('data-duracion') || '';
    document.getElementById('qv-img').src = btn.getAttribute('data-img') || '';
    document.getElementById('qv-url').href = btn.getAttribute('data-url') || '#';
    document.getElementById('qv-desc').textContent = btn.getAttribute('data-desc') || '';  // ← NUEVO
    $('#quickView').modal('show');
  });
})();
</script>
{% endblock %}
